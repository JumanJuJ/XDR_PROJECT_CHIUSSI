using CreatingCaptureFile;
using XDR_Agent.Local;

namespace XDR_Detection.MalwareStaticAnalysis
{
    public class MalwareStaticAnalysis
    {

        public static async Task FullAnalysisAsync(string samplePath, CancellationToken ct)
        {
            var script = "/app/XDR-AgentData/bashScripts/fullAnalysis.sh";
            var analysisEndpoint = $"http://localhost:8080/localEvents/malwareAnalysis";
            var ndjsonPath = "/app/XDR-AgentData/captures/static_results.json";



            var cmd = $"{script} \"{samplePath.Replace("\"", "\\\"")}\"";

            var res = await ShellHelperLocal.BashAsync(cmd, ct);

            if (res.ExitCode != 0)
            {
                Log.WriteLog($"[STATIC] fullAnalysis FAILED exit={res.ExitCode}\nSTDERR:\n{res.StdErr}\nSTDOUT:\n{res.StdOut}",
                    "ERROR", "LOCAL");
                return; // best-effort
            }
            //await LocalAgentWorker.SendNdjsonToManagerAsync(LocalAgentWorker.httpClient, analysisEndpoint, ndjsonPath, ct);


            Log.WriteLog($"[STATIC] fullAnalysis OK\n{res.StdOut}", "INFO", "LOCAL");
        }


    }
}
