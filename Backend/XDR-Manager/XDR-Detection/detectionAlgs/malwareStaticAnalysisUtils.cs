
using Newtonsoft.Json;
using XDR.Models.StaticAnalysis;
using static XDR_Classes.localModels.virusTotalIp;.

namespace XDR_Detection.utils
{
    public static class MalwareStaticAnalysisUtils
    {
        private static readonly HttpClient _httpClient = new();

        private const int INCIDENT_THRESHOLD = 30;

        public static async Task<bool> FullDetectionAsync(malwareAnalysisModel model, CancellationToken ct)
        {
            if (model == null) return false;

            var score = await CalculateRiskScoreAsync(model, ct);
            return score >= INCIDENT_THRESHOLD;
        }

        // ========= RATING SYSTEM =========

        public static async Task<int> CalculateRiskScoreAsync(malwareAnalysisModel model, CancellationToken ct)
        {
            int score = 0;

            // IOC presenti
            if (model.Urls != null && model.Urls.Count > 0) score += 20;
            if (model.Ips != null && model.Ips.Count > 0) score += 20;

            // Tipo file sospetto
            if (IsSuspiciousFileType(model.FileType, model.Name)) score += 15;

            // Path sospetto (euristiche)
            if (IsSuspiciousPath(model.Path)) score += 15;

            // Nome sospetto (doppia estensione, ecc.)
            if (HasSuspiciousName(model.Name)) score += 10;

            // StringsCount come segnale grezzo
            if (IsWeirdStringsCount(model.StringsCount, model.FileType)) score += 10;

            // Boost VT (include SHA256 /files/{id})
            score += await VirusTotalBoostAsync(model, ct);

            if (score < 0) score = 0;
            if (score > 100) score = 100;

            return score;
        }

        private static async Task<int> VirusTotalBoostAsync(malwareAnalysisModel model, CancellationToken ct)
        {
            int boost = 0;

            // 0) FILE HASH (SHA256) -> API FONDAMENTALE: GET /files/{id}
            if (!string.IsNullOrWhiteSpace(model.Sha256) && IsSha256Hex(model.Sha256!))
            {
                var json = await QueryVirusTotalFileAsync(_httpClient, model.Sha256!, ct);
                if (json != null)
                {
                    var vtFile = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vtFile?.data?.attributes?.last_analysis_stats;

                    var malicious = stats?.malicious ?? 0;
                    var suspicious = stats?.suspicious ?? 0;

                    if (malicious > 0) return 50;
                    if (suspicious > 0) boost = Math.Max(boost, 20);
                }
            }

            // 1) IPs
            if (model.Ips != null)
            {
                foreach (var ip in model.Ips)
                {
                    var json = await QueryVirusTotalIpAsync(_httpClient, ip, ct);
                    if (json == null) continue;

                    var vtResponse = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vtResponse?.data?.attributes?.last_analysis_stats;

                    var malicious = stats?.malicious ?? 0;
                    var suspicious = stats?.suspicious ?? 0;

                    if (malicious > 0) return Math.Max(boost, 30);
                    if (suspicious > 0) boost = Math.Max(boost, 10);
                }
            }

            // 2) URLs
            if (model.Urls != null)
            {
                foreach (var rawUrl in model.Urls)
                {
                    var url = NormalizeUrl(rawUrl);

                    var json = await QueryVirusTotalUrlAsync(_httpClient, url, ct);
                    if (json == null) continue;

                    var vt = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vt?.data?.attributes?.last_analysis_stats;

                    var malicious = stats?.malicious ?? 0;
                    var suspicious = stats?.suspicious ?? 0;

                    if (malicious > 0) return Math.Max(boost, 30);
                    if (suspicious > 0) boost = Math.Max(boost, 10);
                }
            }

            return boost;
        }

        // ========= VT QUERIES =========

        public static async Task<string?> QueryVirusTotalFileAsync(HttpClient httpClient, string sha256, CancellationToken ct)
        {
            var apiKey = Environment.GetEnvironmentVariable("VT_API_KEY");
            if (string.IsNullOrWhiteSpace(apiKey))
                throw new InvalidOperationException("VT_API_KEY not set");

            sha256 = sha256.Trim();
            if (!IsSha256Hex(sha256))
                return null;

            var url = $"https://www.virustotal.com/api/v3/files/{sha256}";

            using var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("x-apikey", apiKey);
            request.Headers.Add("Accept", "application/json");

            using var response = await httpClient.SendAsync(request, ct);

            if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                return null;

            if (!response.IsSuccessStatusCode)
            {
                var err = await response.Content.ReadAsStringAsync(ct);
                throw new Exception($"VirusTotal error {(int)response.StatusCode}: {err}");
            }

            return await response.Content.ReadAsStringAsync(ct);
        }

        public static async Task<string?> QueryVirusTotalIpAsync(HttpClient httpClient, string ip, CancellationToken ct)
        {
            var apiKey = Environment.GetEnvironmentVariable("VT_API_KEY");
            if (string.IsNullOrWhiteSpace(apiKey))
                throw new InvalidOperationException("VT_API_KEY not set");

            var url = $"https://www.virustotal.com/api/v3/ip_addresses/{ip}";

            using var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("x-apikey", apiKey);
            request.Headers.Add("Accept", "application/json");

            using var response = await httpClient.SendAsync(request, ct);

            if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                return null;

            if (!response.IsSuccessStatusCode)
            {
                var err = await response.Content.ReadAsStringAsync(ct);
                throw new Exception($"VirusTotal error {(int)response.StatusCode}: {err}");
            }

            return await response.Content.ReadAsStringAsync(ct);
        }

        public static async Task<string?> QueryVirusTotalUrlAsync(HttpClient httpClient, string url, CancellationToken ct)
        {
            var apiKey = Environment.GetEnvironmentVariable("VT_API_KEY");
            if (string.IsNullOrWhiteSpace(apiKey))
                throw new InvalidOperationException("VT_API_KEY not set");

            url = NormalizeUrl(url);

            var urlId = VirusTotalUrlId.ToUrlId(url);
            var endpoint = $"https://www.virustotal.com/api/v3/urls/{urlId}";

            using var request = new HttpRequestMessage(HttpMethod.Get, endpoint);
            request.Headers.Add("x-apikey", apiKey);
            request.Headers.Add("Accept", "application/json");

            using var response = await httpClient.SendAsync(request, ct);

            if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                return null;

            if (!response.IsSuccessStatusCode)
            {
                var err = await response.Content.ReadAsStringAsync(ct);
                throw new Exception($"VirusTotal error {(int)response.StatusCode}: {err}");
            }

            return await response.Content.ReadAsStringAsync(ct);
        }

        // ========= HEURISTICS =========

        public static bool IsSuspiciousFileType(string? fileType, string? fileName = null)
        {
            if (string.IsNullOrWhiteSpace(fileType) && string.IsNullOrWhiteSpace(fileName))
                return false;

            fileType = fileType?.ToLowerInvariant().Trim();
            fileName = fileName?.ToLowerInvariant().Trim();

            var dangerousTypes = new HashSet<string>
            {
                "exe", "dll", "sys",
                "ps1", "vbs", "vbe", "js", "jse",
                "bat", "cmd",
                "sh", "elf"
            };

            if (fileType != null && dangerousTypes.Contains(fileType))
                return true;

            var macroDocs = new HashSet<string>
            {
                "docm", "xlsm", "pptm",
                "doc", "xls", "ppt",
                "rtf"
            };

            if (fileType != null && macroDocs.Contains(fileType))
                return true;

            var archives = new HashSet<string> { "zip", "rar", "7z", "iso", "img" };

            if (fileType != null && archives.Contains(fileType))
                return true;

            if (!string.IsNullOrWhiteSpace(fileName))
            {
                var parts = fileName.Split('.');
                if (parts.Length >= 3)
                {
                    var last = parts[^1];
                    if (dangerousTypes.Contains(last) || macroDocs.Contains(last))
                        return true;
                }
            }

            return false;
        }

        private static bool IsSuspiciousPath(string? path)
        {
            if (string.IsNullOrWhiteSpace(path)) return false;

            path = path.ToLowerInvariant();

            return path.Contains("appdata") ||
                   path.Contains(@"\temp") ||
                   path.Contains("/tmp") ||
                   path.Contains("/dev/shm") ||
                   path.Contains("programdata") ||
                   path.Contains("startup");
        }

        private static bool HasSuspiciousName(string? name)
        {
            if (string.IsNullOrWhiteSpace(name)) return false;

            name = name.ToLowerInvariant();

            if (name.Split('.').Length >= 3) return true;
            if (name.Length <= 12 && name.Any(char.IsDigit)) return true;

            return false;
        }

        private static bool IsWeirdStringsCount(int count, string? fileType)
        {
            if (count <= 0) return false;

            fileType = fileType?.ToLowerInvariant() ?? "";

            if (fileType is "exe" or "dll")
                return count < 50 || count > 10000;

            return false;
        }

        // ========= UTIL =========

        private static bool IsSha256Hex(string sha)
        {
            if (sha.Length != 64) return false;
            for (int i = 0; i < sha.Length; i++)
            {
                char c = sha[i];
                bool isHex =
                    (c >= '0' && c <= '9') ||
                    (c >= 'a' && c <= 'f') ||
                    (c >= 'A' && c <= 'F');
                if (!isHex) return false;
            }
            return true;
        }

        private static string NormalizeUrl(string url)
        {
            url = (url ?? string.Empty).Trim();
            if (url.Length == 0) return url;

            if (!url.StartsWith("http://", StringComparison.OrdinalIgnoreCase) &&
                !url.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            {
                url = "https://" + url;
            }

            return url;
        }
    }
}
