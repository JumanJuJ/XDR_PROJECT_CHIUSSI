
using static XDR_Classes.localModels.virusTotalIp; 

namespace XDR_Detection.utils
{
    public static class StaticAnalysisIngestService
    {
        private const string RAW_COLLECTION = "malwareIncidentRaw";
        private const string INCIDENTS_COLLECTION = "malwareReport";

        public static async Task<StaticMalwareIncident?> ProcessStaticAnalysisAsync(
            IMongoDatabase db,
            malwareAnalysisModel model,
            CancellationToken ct)
        {
            if (db == null) throw new ArgumentNullException(nameof(db));
            if (model == null) throw new ArgumentNullException(nameof(model));

            var rawColl = db.GetCollection<MalwareStaticRawEvent>(RAW_COLLECTION);
            var rawEvent = MalwareStaticRawEvent.FromModel(model);
            await rawColl.InsertOneAsync(rawEvent, cancellationToken: ct);

            var score = await MalwareStaticAnalysisUtils.CalculateRiskScoreAsync(model, ct);
            var isIncident = score >= 30; 

            if (!isIncident)
                return null;

            var incident = await BuildIncidentAsync(rawEvent.Id, model, score, ct);

            var incColl = db.GetCollection<StaticMalwareIncident>(INCIDENTS_COLLECTION);
            await incColl.InsertOneAsync(incident, cancellationToken: ct);

            return incident;
        }

        private static async Task<StaticMalwareIncident> BuildIncidentAsync(
            ObjectId rawEventId,
            malwareAnalysisModel model,
            int score,
            CancellationToken ct)
        {
            var reasons = new List<string>();

            if (!string.IsNullOrWhiteSpace(model.Sha256)) reasons.Add("SHA256 present");
            if (model.Urls?.Count > 0) reasons.Add($"URLs found: {model.Urls.Count}");
            if (model.Ips?.Count > 0) reasons.Add($"IPs found: {model.Ips.Count}");
            if (MalwareStaticAnalysisUtils.IsSuspiciousFileType(model.FileType, model.Name))
                reasons.Add($"Suspicious file type: {model.FileType} ({model.Name})");

            var verdict = score >= 70 ? "HIGH" : score >= 40 ? "MEDIUM" : "LOW";

            var findings = new List<VtIocFinding>();
            bool vtMaliciousHit = false;
            bool vtSuspiciousHit = false;

            if (!string.IsNullOrWhiteSpace(model.Sha256))
            {
                var json = await MalwareStaticAnalysisUtils.QueryVirusTotalFileAsync(
                    GetSharedHttpClient(), model.Sha256!, ct);

                if (json == null)
                {
                    findings.Add(new VtIocFinding
                    {
                        Type = "file",
                        Value = model.Sha256!,
                        FoundOnVt = false
                    });
                }
                else
                {
                    var vt = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vt?.data?.attributes?.last_analysis_stats;

                    var mal = stats?.malicious ?? 0;
                    var sus = stats?.suspicious ?? 0;

                    vtMaliciousHit |= mal > 0;
                    vtSuspiciousHit |= sus > 0;

                    findings.Add(new VtIocFinding
                    {
                        Type = "file",
                        Value = model.Sha256!,
                        FoundOnVt = true,
                        Malicious = mal,
                        Suspicious = sus,
                        Harmless = stats?.harmless ?? 0,
                        Undetected = stats?.undetected ?? 0,
                        Timeout = stats?.timeout ?? 0
                    });

                    if (mal > 0) reasons.Add("VirusTotal file hash: malicious");
                    else if (sus > 0) reasons.Add("VirusTotal file hash: suspicious");
                }
            }

            // IP findings
            if (model.Ips != null)
            {
                foreach (var ip in model.Ips)
                {
                    var json = await MalwareStaticAnalysisUtils.QueryVirusTotalIpAsync(
                        GetSharedHttpClient(), ip, ct);

                    if (json == null)
                    {
                        findings.Add(new VtIocFinding { Type = "ip", Value = ip, FoundOnVt = false });
                        continue;
                    }

                    var vt = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vt?.data?.attributes?.last_analysis_stats;

                    var mal = stats?.malicious ?? 0;
                    var sus = stats?.suspicious ?? 0;

                    vtMaliciousHit |= mal > 0;
                    vtSuspiciousHit |= sus > 0;

                    findings.Add(new VtIocFinding
                    {
                        Type = "ip",
                        Value = ip,
                        FoundOnVt = true,
                        Malicious = mal,
                        Suspicious = sus,
                        Harmless = stats?.harmless ?? 0,
                        Undetected = stats?.undetected ?? 0,
                        Timeout = stats?.timeout ?? 0
                    });
                }
            }

            if (model.Urls != null)
            {
                foreach (var url in model.Urls)
                {
                    var json = await MalwareStaticAnalysisUtils.QueryVirusTotalUrlAsync(
                        GetSharedHttpClient(), url, ct);

                    if (json == null)
                    {
                        findings.Add(new VtIocFinding { Type = "url", Value = url, FoundOnVt = false });
                        continue;
                    }

                    var vt = JsonConvert.DeserializeObject<Root>(json);
                    var stats = vt?.data?.attributes?.last_analysis_stats;

                    var mal = stats?.malicious ?? 0;
                    var sus = stats?.suspicious ?? 0;

                    vtMaliciousHit |= mal > 0;
                    vtSuspiciousHit |= sus > 0;

                    findings.Add(new VtIocFinding
                    {
                        Type = "url",
                        Value = url,
                        FoundOnVt = true,
                        Malicious = mal,
                        Suspicious = sus,
                        Harmless = stats?.harmless ?? 0,
                        Undetected = stats?.undetected ?? 0,
                        Timeout = stats?.timeout ?? 0
                    });
                }
            }

            if (vtMaliciousHit) reasons.Add("VirusTotal: at least one finding marked malicious");
            else if (vtSuspiciousHit) reasons.Add("VirusTotal: at least one finding marked suspicious");

            return new StaticMalwareIncident
            {
                RawEventId = rawEventId,
                Timestamp = model.Timestamp,
                EventType = model.EventType,

                Path = model.Path,
                Name = model.Name,
                FileType = model.FileType,
                StringsCount = model.StringsCount,

                Sha256 = model.Sha256,

                Urls = model.Urls ?? new List<string>(),
                Ips = model.Ips ?? new List<string>(),

                Score = score,
                Verdict = verdict,
                IsIncident = true,

                VtMaliciousHit = vtMaliciousHit,
                VtSuspiciousHit = vtSuspiciousHit,
                VtFindings = findings,

                Reasons = reasons
            };
        }

        private static readonly HttpClient _sharedHttpClient = new HttpClient();
        private static HttpClient GetSharedHttpClient() => _sharedHttpClient;
    }

    public sealed class MalwareStaticRawEvent
    {
        [MongoDB.Bson.Serialization.Attributes.BsonId]
        public ObjectId Id { get; set; }

        public string EventType { get; init; } = "static_full";
        public string Path { get; init; } = null!;
        public string Name { get; init; } = null!;
        public string FileType { get; init; } = null!;
        public int StringsCount { get; init; }

        public string? Sha256 { get; init; }

        public List<string> Urls { get; init; } = new();
        public List<string> Ips { get; init; } = new();
        public DateTime Timestamp { get; init; }

        public static MalwareStaticRawEvent FromModel(malwareAnalysisModel m) => new()
        {
            EventType = m.EventType,
            Path = m.Path,
            Name = m.Name,
            FileType = m.FileType,
            StringsCount = m.StringsCount,
            Sha256 = m.Sha256,
            Urls = m.Urls ?? new List<string>(),
            Ips = m.Ips ?? new List<string>(),
            Timestamp = m.Timestamp
        };
    }
}
