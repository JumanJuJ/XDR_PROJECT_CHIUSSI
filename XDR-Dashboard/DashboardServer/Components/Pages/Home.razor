@page "/"
@using System.Text.Json
@using System.Text.Json.Serialization
@using XdrDashboard.Models
@inject IHttpClientFactory Factory

<style>
    .xdr-table {
        table-layout: fixed;
        width: 100%;
        font-size: 14px;
    }

        .xdr-table th,
        .xdr-table td {
            vertical-align: top;
            padding: 8px 10px;
            white-space: normal !important;
            word-break: break-word;
            line-height: 1.35;
        }

    .xdr-col-date {
        min-width: 170px;
        white-space: nowrap !important;
    }

    .xdr-col-threat {
        min-width: 180px;
    }

    .xdr-col-description {
        min-width: 520px;
    }

    .xdr-col-source,
    .xdr-col-destination {
        min-width: 260px;
    }
</style>

<div id="top"></div>

<div class="container" style="max-width:1400px;">
    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-12 col-md-3 col-lg-2 p-0 border-end bg-light">
            <div class="p-3 border-bottom">
                <div class="fw-bold">XDR Dashboard</div>
                <div class="text-muted" style="font-size:12px;">Menu</div>
            </div>

            <div class="list-group list-group-flush">
                <button type="button"
                        class="list-group-item list-group-item-action @(view == ViewMode.Dashboard ? "active" : "")"
                        @onclick="ShowDashboard">
                    🏠 Dashboard
                </button>

                <NavLink class="list-group-item list-group-item-action" href="/alertsHistory">
                    🚨 Alerts History
                </NavLink>

                <NavLink class="btn btn-sm btn-primary" href="/responses">XDR Responses</NavLink>

                <NavLink class="list-group-item list-group-item-action" href="/files" Match="NavLinkMatch.All">
                    📁 Files
                </NavLink>

                <NavLink class="list-group-item list-group-item-action" href="/processes">
                    ⚙️ Processes
                </NavLink>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col p-3">

            @if (loading)
            {
                <div class="alert alert-light border d-flex align-items-center gap-2">
                    <span class="spinner-border spinner-border-sm"></span>
                    <span>Loading...</span>
                </div>
            }
            else if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger">
                    <div class="fw-bold">Errore API</div>
                    <pre style="white-space:pre-wrap; margin:0;">@error</pre>
                </div>
            }
            else
            {
                <!-- TOP BAR -->
                <div class="d-flex gap-3 mb-3" style="overflow-x:auto;">
                    <div class="card" style="min-width:220px;">
                        <div class="card-body">
                            <div class="text-muted">Alert ultimi 7 giorni</div>
                            <div class="fs-2 fw-bold">@items.Count</div>
                        </div>
                    </div>

                    <div class="card" style="min-width:260px;">
                        <div class="card-body">
                            <div class="text-muted mb-2">Level</div>

                            <div class="d-flex justify-content-between">
                                <span class="text-danger fw-semibold">Menace</span>
                                <span class="fw-bold">@lvlHigh</span>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span class="text-warning fw-semibold">Warning</span>
                                <span class="fw-bold">@lvlMed</span>
                            </div>

                            <div class="d-flex justify-content-between">
                                <span class="text-success fw-semibold">Mostly Safe</span>
                                <span class="fw-bold">@lvlLow</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TABLE -->
                <div class="card">
                    <div class="card-body">
                        <div class="fw-bold mb-2">Ultime minacce</div>

                        <div class="table-responsive" style="max-height:65vh; overflow:auto;">
                            <table class="table table-bordered xdr-table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="xdr-col-date">Date</th>
                                        <th>Type</th>
                                        <th class="xdr-col-threat">Threat</th>
                                        <th>Level</th>
                                        <th>Confidence</th>
                                        <th class="xdr-col-description">Description</th>
                                        <th class="xdr-col-source">Source</th>
                                        <th class="xdr-col-destination">Destination</th>
                                        <th>MITRE</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @foreach (var ev in items)
                                    {
                                        <tr>
                                            <td class="xdr-col-date">
                                                @ev.ts.ToString("yyyy-MM-dd HH:mm:ss")
                                            </td>

                                            <td>@KindBadge(ev.kind)</td>

                                            <td class="xdr-col-threat">
                                                <span class="badge bg-secondary">@Pretty(ev.title)</span>
                                            </td>

                                            <td>@LevelBadge(ev.threatLevel)</td>

                                            <td>@ConfidenceBadge(ev.confidence)</td>

                                            <td class="xdr-col-description">
                                                @ev.message
                                            </td>

                                            <td class="xdr-col-source">
                                                @(ev.src ?? "-")
                                            </td>

                                            <td class="xdr-col-destination">
                                                @(ev.dst ?? "-")
                                            </td>

                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(ev.mitreId))
                                                {
                                                    <span class="badge bg-info text-dark">@ev.mitreId</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private const string ApiBase = "https://localhost:7140/";

    private enum ViewMode { Dashboard }
    private ViewMode view = ViewMode.Dashboard;

    private bool loading = true;
    private string? error;

    private List<TimelineDto> items = new();

    private int lvlHigh;
    private int lvlMed;
    private int lvlLow;

    protected override async Task OnInitializedAsync()
    {
        await ShowDashboard();
    }

    private async Task ShowDashboard()
    {
        loading = true;
        error = null;

        try
        {
            var http = Factory.CreateClient();
            http.BaseAddress = new Uri(ApiBase);

            var jsonOpts = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            jsonOpts.Converters.Add(new JsonStringEnumConverter());

            items = await http.GetFromJsonAsync<List<TimelineDto>>(
                "api/alerts/last7days", jsonOpts
            ) ?? new();

            lvlHigh = items.Count(x => x.threatLevel == ThreatLevel.High);
            lvlMed = items.Count(x => x.threatLevel == ThreatLevel.Medium);
            lvlLow = items.Count(x => x.threatLevel == ThreatLevel.Low);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private static string Pretty(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return "-";
        s = s.Replace("_", " ").Replace("-", " ");
        return System.Globalization.CultureInfo.InvariantCulture
            .TextInfo.ToTitleCase(s.ToLowerInvariant());
    }

    private RenderFragment KindBadge(string kind) => builder =>
    {
        var k = (kind ?? "").ToLowerInvariant();

        var (text, css) =
            k.Contains("network") ? ("NETWORK", "badge bg-primary") :
            k.Contains("local") ? ("LOCAL", "badge bg-secondary") :
            k.Contains("malware") ? ("MALWARE", "badge bg-dark") :
            ("OTHER", "badge bg-light text-dark border");

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", css);
        builder.AddContent(2, text);
        builder.CloseElement();
    };

    private RenderFragment LevelBadge(ThreatLevel level) => builder =>
    {
        var (text, css) = level switch
        {
            ThreatLevel.High => ("MENACE", "badge bg-danger"),
            ThreatLevel.Medium => ("WARNING", "badge bg-warning text-dark"),
            ThreatLevel.Low => ("MOSTLY SAFE", "badge bg-success"),
            _ => ("UNKNOWN", "badge bg-secondary")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", css);
        builder.AddContent(2, text);
        builder.CloseElement();
    };

    private RenderFragment ConfidenceBadge(ConfidenceLevel? c) => builder =>
    {
        var (text, css) = c switch
        {
            ConfidenceLevel.High => ("High", "badge bg-dark"),
            ConfidenceLevel.Medium => ("Medium", "badge bg-secondary"),
            ConfidenceLevel.Low => ("Low", "badge bg-light text-dark border"),
            _ => ("Unknown", "badge bg-light text-muted border")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "class", css);
        builder.AddContent(2, text);
        builder.CloseElement();
    };
}

